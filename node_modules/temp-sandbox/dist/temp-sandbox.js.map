{"version":3,"sources":["../src/temp-sandbox.ts"],"names":["writeFile","fs","readFile","getFileHash","contents","hash","update","digest","createFileParseContents","fileContents","JSON","stringify","slice","sandboxDestroyed","Error","getRandomInteger","min","max","randomInteger","Math","floor","random","TempSandbox","constructor","options","resolve","dir","absolute","path","relative","isOutside","split","base","join","joinWithBase","normalized","dir1","dir2","from","to","opts","randomDir","tempDir","realpathSync","os","tmpdir","parent","relativeParent","process","cwd","relativeParentParsed","parse","relateParentStrippedExt","name","packageJson","readPkgUp","sync","normalize","baseDirId","package","replace","dirId","toString","baseDir","existsSync","del","force","bind","createDir","createDirSync","createFile","createFileSync","delete","deleteSync","readFileSync","getFileHashSync","getFileList","getFileListSync","getAllFilesHash","getAllFilesHashSync","clean","cleanSync","destroySandbox","destroySandboxSync","dirCreated","file","fileDir","filePath","writeFileSync","patterns","Array","isArray","forEach","pattern","removed","dot","map","removedFiles","trim","e","fileHash","readDir","fileList","ignore","gitignore","result","pending","Promise","all","sortedResult","Object","keys","sort","a","b","localeCompare","reduce","acc","item","key"],"mappings":"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","sourcesContent":["import path from 'path';\nimport os from 'os';\nimport fs from 'fs';\nimport { createHash } from 'crypto';\nimport { promisify } from 'util';\nimport makeDir, { sync as makeDirSync } from 'make-dir';\nimport parentModule from 'parent-module';\nimport readPkgUp from 'read-pkg-up';\nimport { readDirDeep, readDirDeepSync } from 'read-dir-deep';\nimport slash from 'slash';\nimport { del } from './utils/del';\n\nconst writeFile = promisify(fs.writeFile);\nconst readFile = promisify(fs.readFile);\n\nfunction getFileHash(contents: Buffer): string {\n\tconst hash = createHash('md5')\n\t\t.update(contents)\n\t\t.digest('hex');\n\n\treturn hash;\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction createFileParseContents(contents: any = ''): string {\n\tlet fileContents = contents;\n\n\tif (fileContents === null) {\n\t\tfileContents = '';\n\t}\n\n\tif (typeof fileContents !== 'string') {\n\t\tfileContents = JSON.stringify(fileContents, null, 4);\n\t}\n\n\t// all files append new line unless empty\n\tif (fileContents.slice(-1) !== '\\n' && fileContents !== '') {\n\t\tfileContents += '\\n';\n\t}\n\n\treturn fileContents;\n}\n\nfunction sandboxDestroyed(): void {\n\tthrow new Error('sandbox has been destroyed. Create new instance');\n}\n\n// https://stackoverflow.com/a/1527820\nfunction getRandomInteger(min: number = 1, max: number = 100): number {\n\tconst randomInteger = Math.floor(Math.random() * (max - min + 1)) + min;\n\n\treturn randomInteger;\n}\n\ninterface Options {\n\trandomDir?: boolean;\n}\n\nclass TempSandbox {\n\tpublic readonly dir: string;\n\n\tpublic constructor(options: Options = {}) {\n\t\tconst opts = {\n\t\t\trandomDir: false,\n\t\t\t...options,\n\t\t};\n\n\t\tconst tempDir = fs.realpathSync(os.tmpdir());\n\t\tconst parent =\n\t\t\tparentModule() || `PARENT-NOT-FOUND-${getRandomInteger()}`;\n\n\t\tconst relativeParent = path.relative(process.cwd(), parent);\n\t\tconst relativeParentParsed = path.parse(relativeParent);\n\n\t\tconst relateParentStrippedExt = path.join(\n\t\t\trelativeParentParsed.dir,\n\t\t\trelativeParentParsed.name,\n\t\t);\n\n\t\t/**\n\t\t * create base directory based on package name\n\t\t */\n\t\tconst packageJson = readPkgUp.sync({\n\t\t\tcwd: parent,\n\t\t\tnormalize: false,\n\t\t});\n\n\t\tconst baseDirId =\n\t\t\tpackageJson && packageJson.package && packageJson.package.name\n\t\t\t\t? packageJson.package.name\n\t\t\t\t\t\t// replace special characters for directory name\n\t\t\t\t\t\t.replace(/[^a-zA-Z0-9]/g, '-')\n\t\t\t\t: null;\n\n\t\tif (baseDirId === null) {\n\t\t\tthrow new Error('package name not found');\n\t\t}\n\n\t\tconst dirId =\n\t\t\topts.randomDir === false ? 'dir' : getRandomInteger().toString();\n\n\t\tconst baseDir = path.resolve(tempDir, `${baseDirId}-sandbox`);\n\n\t\t/**\n\t\t * Each temp directory will be unique to the file\n\t\t */\n\t\tthis.dir = slash(\n\t\t\tpath.resolve(baseDir, `${relateParentStrippedExt}-${dirId}`),\n\t\t);\n\n\t\t// Remove target temp directory if it already exists\n\t\tif (fs.existsSync(this.dir)) {\n\t\t\tdel.sync(this.dir, { force: true });\n\t\t}\n\n\t\t// create sandbox directory\n\t\tmakeDirSync(this.dir);\n\n\t\tthis.path.relative = this.path.relative.bind(this);\n\t\tthis.path.resolve = this.path.resolve.bind(this);\n\n\t\tthis.createDir = this.createDir.bind(this);\n\t\tthis.createDirSync = this.createDirSync.bind(this);\n\n\t\tthis.createFile = this.createFile.bind(this);\n\t\tthis.createFileSync = this.createFileSync.bind(this);\n\n\t\tthis.delete = this.delete.bind(this);\n\t\tthis.deleteSync = this.deleteSync.bind(this);\n\n\t\tthis.readFile = this.readFile.bind(this);\n\t\tthis.readFileSync = this.readFileSync.bind(this);\n\n\t\tthis.getFileHash = this.getFileHash.bind(this);\n\t\tthis.getFileHashSync = this.getFileHashSync.bind(this);\n\n\t\tthis.getFileList = this.getFileList.bind(this);\n\t\tthis.getFileListSync = this.getFileListSync.bind(this);\n\n\t\tthis.getAllFilesHash = this.getAllFilesHash.bind(this);\n\t\tthis.getAllFilesHashSync = this.getAllFilesHashSync.bind(this);\n\n\t\tthis.clean = this.clean.bind(this);\n\t\tthis.cleanSync = this.cleanSync.bind(this);\n\n\t\tthis.destroySandbox = this.destroySandbox.bind(this);\n\t\tthis.destroySandboxSync = this.destroySandboxSync.bind(this);\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/member-ordering\n\tpublic path = {\n\t\tresolve: (dir: string): string => {\n\t\t\tconst absolute = path.resolve(this.dir, dir);\n\t\t\tconst relative = path.relative(this.dir, absolute);\n\n\t\t\tconst isOutside =\n\t\t\t\trelative !== '' ? relative.split('..')[0] === '' : false;\n\n\t\t\tif (isOutside) {\n\t\t\t\tthrow new Error(`${dir} is outside sandbox`);\n\t\t\t}\n\n\t\t\t// Treat the directory as if it is the root of the filesystem\n\t\t\tconst base = path.join('/', relative);\n\n\t\t\tconst joinWithBase = path.join(this.dir, base);\n\n\t\t\tconst normalized = slash(path.resolve(joinWithBase));\n\n\t\t\treturn normalized;\n\t\t},\n\n\t\trelative: (dir1: string, dir2?: string): string => {\n\t\t\tconst from = dir2 ? this.path.resolve(dir1) : this.dir;\n\t\t\tconst to = dir2 ? this.path.resolve(dir2) : this.path.resolve(dir1);\n\n\t\t\tconst relative = slash(path.relative(from, to));\n\n\t\t\treturn relative;\n\t\t},\n\t};\n\n\tpublic async createDir(dir: string): Promise<string> {\n\t\tconst normalized = this.path.resolve(dir);\n\t\tconst dirCreated = await makeDir(normalized);\n\n\t\treturn this.path.relative(dirCreated);\n\t}\n\n\tpublic createDirSync(dir: string): string {\n\t\tconst normalized = this.path.resolve(dir);\n\n\t\tconst dirCreated = makeDirSync(normalized);\n\n\t\treturn this.path.relative(dirCreated);\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\tpublic async createFile(file: string, contents: any = ''): Promise<void> {\n\t\tconst fileDir = path.parse(file).dir;\n\n\t\tif (fileDir) {\n\t\t\tawait this.createDir(fileDir);\n\t\t}\n\n\t\tconst filePath = this.path.resolve(file);\n\t\tconst fileContents = createFileParseContents(contents);\n\t\tawait writeFile(filePath, fileContents);\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\tpublic createFileSync(file: string, contents: any = ''): void {\n\t\tconst fileDir = path.parse(file).dir;\n\n\t\tif (fileDir) {\n\t\t\tthis.createDirSync(fileDir);\n\t\t}\n\n\t\tconst filePath = this.path.resolve(file);\n\t\tconst fileContents = createFileParseContents(contents);\n\n\t\tfs.writeFileSync(filePath, fileContents);\n\t}\n\n\tpublic async delete(patterns: string | string[]): Promise<string[]> {\n\t\t(Array.isArray(patterns) ? patterns : [patterns]).forEach(\n\t\t\t(pattern): void => {\n\t\t\t\tif (typeof pattern !== 'string') {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t`delete patterns must be a string. Received type: \"${typeof pattern}\"`,\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tconst filePath = this.path.resolve(pattern);\n\n\t\t\t\tif (filePath === this.dir) {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t'Use sandbox.destroySandbox() to delete the sandbox.',\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t},\n\t\t);\n\n\t\tconst removed = await del(patterns, {\n\t\t\tcwd: this.dir,\n\t\t\tdot: true,\n\t\t\tforce: true,\n\t\t});\n\n\t\treturn removed.map((removedFiles): string => {\n\t\t\treturn this.path.relative(removedFiles);\n\t\t});\n\t}\n\n\tpublic deleteSync(patterns: string | string[]): string[] {\n\t\t(Array.isArray(patterns) ? patterns : [patterns]).forEach(\n\t\t\t(pattern): void => {\n\t\t\t\tif (typeof pattern !== 'string') {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t`delete patterns must be a string. Received type: \"${typeof pattern}\"`,\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tconst filePath = this.path.resolve(pattern);\n\n\t\t\t\tif (filePath === this.dir) {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t'Use sandbox.destroySandboxSync() to delete the sandbox.',\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t},\n\t\t);\n\n\t\tconst removed = del.sync(patterns, {\n\t\t\tcwd: this.dir,\n\t\t\tdot: true,\n\t\t\tforce: true,\n\t\t});\n\n\t\treturn removed.map((removedFiles: string): string => {\n\t\t\treturn this.path.relative(removedFiles);\n\t\t});\n\t}\n\n\tpublic async readFile(file: string): Promise<unknown> {\n\t\tconst filePath = this.path.resolve(file);\n\t\tlet contents = await readFile(filePath, 'utf8');\n\n\t\ttry {\n\t\t\tcontents = contents.trim();\n\t\t\tcontents = JSON.parse(contents);\n\t\t\t// eslint-disable-next-line no-empty\n\t\t} catch (e) {}\n\n\t\treturn contents;\n\t}\n\n\tpublic readFileSync(file: string): unknown {\n\t\tconst filePath = this.path.resolve(file);\n\n\t\tlet contents = fs.readFileSync(filePath, 'utf8');\n\n\t\ttry {\n\t\t\tcontents = contents.trim();\n\t\t\tcontents = JSON.parse(contents);\n\t\t\t// eslint-disable-next-line no-empty\n\t\t} catch (e) {}\n\n\t\treturn contents;\n\t}\n\n\tpublic async getFileHash(file: string): Promise<string> {\n\t\tconst filePath = this.path.resolve(file);\n\t\tconst contents = await readFile(filePath);\n\n\t\tconst fileHash = getFileHash(contents);\n\n\t\treturn fileHash;\n\t}\n\n\tpublic getFileHashSync(file: string): string {\n\t\tconst filePath = this.path.resolve(file);\n\t\tconst contents = fs.readFileSync(filePath);\n\n\t\tconst fileHash = getFileHash(contents);\n\n\t\treturn fileHash;\n\t}\n\n\tpublic async getFileList(dir?: string): Promise<string[]> {\n\t\tconst readDir = dir ? this.path.resolve(dir) : this.dir;\n\n\t\tconst fileList = await readDirDeep(readDir, {\n\t\t\tcwd: this.dir,\n\t\t\tabsolute: false,\n\t\t\tignore: [],\n\t\t\tgitignore: false,\n\t\t});\n\n\t\treturn fileList;\n\t}\n\n\tpublic getFileListSync(dir?: string): string[] {\n\t\tconst readDir = dir ? this.path.resolve(dir) : this.dir;\n\t\tconst fileList = readDirDeepSync(readDir, {\n\t\t\tcwd: this.dir,\n\t\t\tabsolute: false,\n\t\t\tignore: [],\n\t\t\tgitignore: false,\n\t\t});\n\n\t\treturn fileList;\n\t}\n\n\tpublic async getAllFilesHash(\n\t\tdir?: string,\n\t): Promise<{ [key: string]: string }> {\n\t\tconst fileList = await this.getFileList(dir);\n\n\t\tconst result: { [key: string]: string } = {};\n\t\tconst pending = fileList.map(\n\t\t\tasync (file: string): Promise<void> => {\n\t\t\t\tconst hash = await this.getFileHash(file);\n\n\t\t\t\tresult[file] = hash;\n\t\t\t},\n\t\t);\n\n\t\tawait Promise.all(pending);\n\n\t\tconst sortedResult = Object.keys(result)\n\t\t\t.sort((a: string, b: string): number => {\n\t\t\t\treturn a.localeCompare(b);\n\t\t\t})\n\t\t\t.reduce((acc, item): { [key: string]: string } => {\n\t\t\t\treturn { ...acc, [item]: result[item] };\n\t\t\t}, {});\n\n\t\treturn sortedResult;\n\t}\n\n\tpublic getAllFilesHashSync(dir?: string): { [key: string]: string } {\n\t\tconst fileList = this.getFileListSync(dir);\n\n\t\tconst result: { [key: string]: string } = fileList.reduce(\n\t\t\t(\n\t\t\t\tacc: { [key: string]: string },\n\t\t\t\tfile: string,\n\t\t\t): { [key: string]: string } => {\n\t\t\t\tconst fileHash = this.getFileHashSync(file);\n\n\t\t\t\treturn {\n\t\t\t\t\t...acc,\n\t\t\t\t\t[file]: fileHash,\n\t\t\t\t};\n\t\t\t},\n\t\t\t{},\n\t\t);\n\n\t\tconst sortedResult = Object.keys(result)\n\t\t\t.sort((a: string, b: string): number => {\n\t\t\t\treturn a.localeCompare(b);\n\t\t\t})\n\t\t\t.reduce((acc, item): { [key: string]: string } => {\n\t\t\t\treturn { ...acc, [item]: result[item] };\n\t\t\t}, {});\n\n\t\treturn sortedResult;\n\t}\n\n\tpublic async clean(): Promise<string[]> {\n\t\tconst removed = await del('**/*', {\n\t\t\tcwd: this.dir,\n\t\t\tdot: true,\n\t\t\tforce: true,\n\t\t});\n\n\t\treturn removed.map((removedFiles): string => {\n\t\t\treturn slash(this.path.relative(removedFiles));\n\t\t});\n\t}\n\n\tpublic cleanSync(): string[] {\n\t\tconst removed = del.sync('**/*', {\n\t\t\tcwd: this.dir,\n\t\t\tdot: true,\n\t\t\tforce: true,\n\t\t});\n\n\t\treturn removed.map((removedFiles: string): string => {\n\t\t\treturn slash(this.path.relative(removedFiles));\n\t\t});\n\t}\n\n\tpublic async destroySandbox(): Promise<string[]> {\n\t\tconst removed = await del(this.dir, { force: true });\n\n\t\tfor (const key of Object.keys(this)) {\n\t\t\tif (key === 'dir') {\n\t\t\t\t// @ts-ignore\n\t\t\t\tdelete this.dir;\n\t\t\t} else {\n\t\t\t\t// @ts-ignore\n\t\t\t\tthis[key] = sandboxDestroyed;\n\t\t\t}\n\t\t}\n\n\t\treturn removed.map((file): string => {\n\t\t\treturn slash(file);\n\t\t});\n\t}\n\n\tpublic destroySandboxSync(): string[] {\n\t\tconst removed = del.sync(this.dir, { force: true });\n\n\t\tfor (const key of Object.keys(this)) {\n\t\t\tif (key === 'dir') {\n\t\t\t\t// @ts-ignore\n\t\t\t\tdelete this.dir;\n\t\t\t} else {\n\t\t\t\t// @ts-ignore\n\t\t\t\tthis[key] = sandboxDestroyed;\n\t\t\t}\n\t\t}\n\n\t\treturn removed.map((file): string => {\n\t\t\treturn slash(file);\n\t\t});\n\t}\n}\n\nexport { TempSandbox };\n"],"file":"temp-sandbox.js"}